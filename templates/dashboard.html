<!-- templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EcoQuant</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0F7D5C',
                        secondary: '#0099A0',
                        accent: '#12303B',
                        light: '#F2FCF9',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .stat-card { transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .project-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .nav-link {
            position: relative;
            color: #12303B; /* text-accent */
            font-weight: 500; /* font-medium */
            transition: color 0.2s;
        }
        .nav-link:hover {
            color: #0F7D5C; /* text-primary */
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0%;
            height: 2px;
            background-color: #0F7D5C; /* Tailwind primary green */
            transition: width 0.3s ease;
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .nav-link.active {
            color: #0F7D5C;
            font-weight: 600;
        }

        .nav-link.active::after {
            width: 100%;
        }
        
        .pagination-btn {
            transition: all 0.2s ease;
        }
        
        .pagination-btn.active {
            background-color: #0F7D5C;
            color: white;
        }
    </style>

</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white text-accent shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="/home" class="flex items-center space-x-2 hover:text-green">
                <i class="fas fa-leaf text-2xl text-primary"></i>
                <span class="text-xl font-bold">EcoQuant</span>
            </a>
            <div class="hidden md:flex space-x-6">
                <a href="/home" class="nav-link">Home</a>
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="/carbon" class="nav-link">Carbon Credits</a>
                <a href="/reports" class="nav-link">Reports</a>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <!-- Add ID to profile button -->
                    <button id="profile-btn" class="flex items-center space-x-2 hover:text-green">
                        <div class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white">
                            <span>{{ username[0] }}{{ username[1] if username|length > 1 else '' }}</span>
                        </div>
                        <span>{{ username }}</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <!-- Add ID to dropdown menu -->
                    <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden">
                        <!-- <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-user mr-2"></i>Profile
                        </a> -->
                        <a href="/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </a>
                    </div>
                </div>
                <button class="md:hidden text-accent">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <div class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-2xl font-bold text-accent">Project Dashboard</h1>
                    <p class="text-gray-600">Track and manage carbon emissions across all your infrastructure projects</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <a href="/new-project" class="bg-primary text-white px-5 py-2.5 rounded-lg font-medium hover:bg-secondary transition flex items-center">
                        <i class="fas fa-plus mr-2"></i> New Project
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Total Projects -->
            <div class="bg-white rounded-xl p-5 card-shadow stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Projects</p>
                        <h3 class="text-2xl font-bold text-accent mt-1">{{ projects|length }}</h3>
                    </div>
                    <div class="bg-light p-3 rounded-lg">
                        <i class="fas fa-folder-tree text-xl text-primary"></i>
                    </div>
                </div>
                <!-- <p class="text-xs text-gray-500 mt-3"><span class="text-green-500 font-medium">+3 this month</span></p> -->
            </div>
            
            <!-- CO₂e Reduced -->
            <div class="bg-white rounded-xl p-5 card-shadow stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">CO₂e Reduced</p>
                        <h3 class="text-2xl font-bold text-accent mt-1">{{ total_co2e|round|int }} t</h3>
                    </div>
                    <div class="bg-light p-3 rounded-lg">
                        <i class="fas fa-cloud text-xl text-primary"></i>
                    </div>
                </div>
                <!-- <p class="text-xs text-gray-500 mt-3"><span class="text-green-500 font-medium">↑ 18% from last quarter</span></p> -->
            </div>
            
            <!-- Carbon Credits -->
            <div class="bg-white rounded-xl p-5 card-shadow stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Carbon Credits</p>
                        <h3 class="text-2xl font-bold text-accent mt-1">{{ total_credits|round|int }}</h3>
                    </div>
                    <div class="bg-light p-3 rounded-lg">
                        <i class="fas fa-coins text-xl text-primary"></i>
                    </div>
                </div>
                <!-- <p class="text-xs text-gray-500 mt-3"><span class="text-green-500 font-medium">₹ 1.2M value</span></p> -->
            </div>
            
            <!-- Avg. Reduction -->
            <div class="bg-white rounded-xl p-5 card-shadow stat-card">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Avg. Reduction</p>
                            <h3 class="text-2xl font-bold text-accent mt-1">
                                {% if projects %}
                                    {{ (projects|sum(attribute='reduction') / projects|length)|round(1) }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </h3>
                    </div>
                    <div class="bg-light p-3 rounded-lg">
                        <i class="fas fa-chart-line text-xl text-primary"></i>
                    </div>
                </div>
                <!-- <p class="text-xs text-gray-500 mt-3"><span class="text-green-500 font-medium">↑ 3.2% YoY</span></p> -->
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Emissions by Scope -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-accent">Emissions by Scope</h2>
                    <!-- <div class="flex space-x-2">
                        <button class="text-gray-500 hover:text-primary">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="text-gray-500 hover:text-primary">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div> -->
                </div>
                <div class="h-64">
                    <canvas id="scopeChart"></canvas>
                </div>
            </div>
            
            <!-- Emission Trends -->
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-accent">Emission Reduction Trends</h2>
                    <!-- <select class="text-sm border border-gray-300 rounded px-3 py-1 bg-white">
                        <option>Last 6 Months</option>
                        <option>Last Year</option>
                        <option>Last 3 Years</option>
                    </select> -->
                </div>
                <div class="h-64">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Projects Section -->
        <div class="bg-white rounded-xl p-6 card-shadow mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-accent">All Projects</h2>
                <div class="flex space-x-3">
                    <div class="relative">
                        <input type="text" placeholder="Search projects..." class="border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-primary focus:border-transparent w-48">
                        <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                    </div>
                    <!-- <button class="text-gray-500 hover:text-primary">
                        <i class="fas fa-filter"></i>
                    </button> -->
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-light text-gray-600 text-left">
                        <tr>
                            <th class="py-3 px-4 font-medium rounded-l-lg">Project</th>
                            <th class="py-3 px-4 font-medium">Type</th>
                            <th class="py-3 px-4 font-medium">CO₂e (t)</th>
                            <th class="py-3 px-4 font-medium">Reduction</th>
                            <th class="py-3 px-4 font-medium">Credits</th>
                            <th class="py-3 px-4 font-medium">Status</th>
                            <th class="py-3 px-4 font-medium rounded-r-lg">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projects-tbody">
                        {% for project in projects %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50 project-row" data-status="{{ project.status }}" data-date="{{ project.date }}">
                            <td class="py-4 px-4">
                                <a href="/project/{{ project.id }}" class="font-medium text-accent hover:text-primary">{{ project.name }}</a>
                                <p class="text-xs text-gray-500 mt-1">{{ project.date }}</p>
                            </td>
                            <td class="py-4 px-4">
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">{{ project.type }}</span>
                            </td>
                            <td class="py-4 px-4 font-medium">{{ project.co2e|float|round(2) }}</td>
                            <td class="py-4 px-4">
                                <div class="flex items-center">
                                    <span class="text-green-500 font-medium mr-2">{{ project.reduction }}%</span>
                                    <i class="fas fa-arrow-trend-down text-green-500"></i>
                                </div>
                            </td>
                            <td class="py-4 px-4 font-medium">{{ project.credits|float|round(2) }}</td>
                            <td class="py-4 px-4">
                                <span class="status-badge 
                                    {% if project.status == 'Completed' %}bg-green-100 text-green-800
                                    {% elif project.status == 'In Progress' %}bg-blue-100 text-blue-800
                                    {% elif project.status == 'Planning' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ project.status }}
                                </span>
                            </td>
                            <td class="py-4 px-4">
                                <div class="flex space-x-2">
                                    <a href="/project/{{ project.id }}" class="w-8 h-8 rounded-full bg-light flex items-center justify-center text-primary hover:bg-primary hover:text-white">
                                        <i class="fas fa-eye text-sm"></i>
                                    </a>
                                    <button class="w-8 h-8 rounded-full bg-light flex items-center justify-center text-red-500 hover:bg-red-100 delete-project" data-project-id="{{ project.id }}">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center mt-6">
                <p class="text-gray-600 text-sm" id="projects-count">Loading projects...</p>
                <div class="flex space-x-2" id="pagination-controls">
                    <!-- Pagination buttons will be inserted here by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-accent text-white py-8">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <div class="flex justify-center mb-4">
                    <i class="fas fa-leaf text-2xl text-white mr-2"></i>
                    <span class="text-xl font-bold">EcoQuant</span>
                </div>
                <p class="text-gray-300 max-w-2xl mx-auto">Empowering sustainable infrastructure through data-driven carbon management and AI-powered insights.</p>
                <div class="flex justify-center space-x-6 mt-6">
                    <a href="https://x.com/HarshMistry56" class="text-gray-300 hover:text-white"><i class="fab fa-twitter"></i></a>
                    <a href="https://linkedin.com/in/mistryharsh56/" class="text-gray-300 hover:text-white"><i class="fab fa-linkedin"></i></a>
                    <a href="https://www.instagram.com/harshaintharsh?igsh=NnZ6ZHR2a25uaWo4" class="text-gray-300 hover:text-white"><i class="fab fa-instagram"></i></a>
                    <a href="https://github.com/Harsh1456" class="text-gray-300 hover:text-white"><i class="fab fa-github"></i></a>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-6 text-sm text-gray-400">
                    <p>© 2025 EcoQuant. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Navigation active link
        document.addEventListener("DOMContentLoaded", () => {
            const currentPath = window.location.pathname.replace(/\/$/, "");
            document.querySelectorAll('.nav-link').forEach(link => {
                const linkPath = link.getAttribute('href').replace(/\/$/, "");
                if (linkPath && currentPath === linkPath) {
                    link.classList.add('active');
                }
            });
            
            // Initialize pagination
            initializePagination();
        });

        // Initialize pagination functionality
        function initializePagination() {
            const projectsPerPage = 5;
            const projectRows = Array.from(document.querySelectorAll('.project-row'));
            const totalProjects = projectRows.length;
            const totalPages = Math.ceil(totalProjects / projectsPerPage);
            const paginationControls = document.getElementById('pagination-controls');
            const projectsCount = document.getElementById('projects-count');
            
            // Sort projects by status and date
            sortProjects(projectRows);
            
            // Initialize pagination
            let currentPage = 1;
            
            // Function to update displayed projects
            function updateProjectsDisplay() {
                // Hide all projects
                projectRows.forEach(row => {
                    row.style.display = 'none';
                });
                
                // Calculate start and end index for current page
                const startIndex = (currentPage - 1) * projectsPerPage;
                const endIndex = Math.min(startIndex + projectsPerPage, totalProjects);
                
                // Show projects for current page
                for (let i = startIndex; i < endIndex; i++) {
                    if (projectRows[i]) {
                        projectRows[i].style.display = 'table-row';
                    }
                }
                
                // Update projects count text
                projectsCount.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalProjects} projects`;
                
                // Update pagination buttons
                updatePaginationButtons();
            }
            
            // Function to update pagination buttons
            function updatePaginationButtons() {
                // Clear existing buttons
                paginationControls.innerHTML = '';
                
                // Previous button
                const prevButton = document.createElement('button');
                prevButton.className = 'w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-gray-600 hover:bg-gray-100 pagination-btn';
                prevButton.innerHTML = '<i class="fas fa-chevron-left text-xs"></i>';
                prevButton.disabled = currentPage === 1;
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        updateProjectsDisplay();
                    }
                });
                paginationControls.appendChild(prevButton);
                
                // Page number buttons
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                // Adjust if we're at the end
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.className = `w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center pagination-btn ${i === currentPage ? 'active' : 'text-gray-600 hover:bg-gray-100'}`;
                    pageButton.textContent = i;
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        updateProjectsDisplay();
                    });
                    paginationControls.appendChild(pageButton);
                }
                
                // Next button
                const nextButton = document.createElement('button');
                nextButton.className = 'w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center text-gray-600 hover:bg-gray-100 pagination-btn';
                nextButton.innerHTML = '<i class="fas fa-chevron-right text-xs"></i>';
                nextButton.disabled = currentPage === totalPages;
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        updateProjectsDisplay();
                    }
                });
                paginationControls.appendChild(nextButton);
            }
            
            // Function to sort projects by status and date
            function sortProjects(rows) {
                // Define status priority
                const statusPriority = {
                    'Planning': 1,
                    'In Progress': 2,
                    'Completed': 3
                };
                
                // Sort the rows
                rows.sort((a, b) => {
                    const statusA = a.getAttribute('data-status');
                    const statusB = b.getAttribute('data-status');
                    const dateA = a.getAttribute('data-date');
                    const dateB = b.getAttribute('data-date');
                    
                    // First sort by status priority
                    if (statusPriority[statusA] !== statusPriority[statusB]) {
                        return statusPriority[statusA] - statusPriority[statusB];
                    }
                    
                    // Then sort by date (newest first)
                    if (dateA && dateB) {
                        return new Date(dateB) - new Date(dateA);
                    }
                    
                    return 0;
                });
                
                // Reorder the DOM elements
                const tbody = document.getElementById('projects-tbody');
                rows.forEach(row => {
                    tbody.appendChild(row);
                });
            }
            
            // Initialize display
            updateProjectsDisplay();
        }

        // Handle delete project
        document.querySelectorAll('.delete-project').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const projectId = this.getAttribute('data-project-id');
                
                if (confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
                    fetch(`/delete-project/${projectId}`, {
                        method: 'DELETE',
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            window.location.reload();
                        } else {
                            alert('Error deleting project: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Get elements using IDs
            const profileBtn = document.getElementById('profile-btn');
            const userDropdown = document.getElementById('user-dropdown');
            
            if (profileBtn && userDropdown) {
                // Toggle dropdown when profile button is clicked
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('hidden');
                });
                
                // Close dropdown when clicking anywhere else
                document.addEventListener('click', function(e) {
                    const isClickInsideDropdown = userDropdown.contains(e.target);
                    const isClickOnProfileBtn = profileBtn.contains(e.target);
                    
                    if (!isClickInsideDropdown && !isClickOnProfileBtn) {
                        userDropdown.classList.add('hidden');
                    }
                });
                
                // Prevent dropdown from closing when clicking inside it
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });

        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            // Scope Chart - using dynamic data
            const scopeCtx = document.getElementById('scopeChart').getContext('2d');
            const scopeChart = new Chart(scopeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Direct Emissions', 'Energy Indirect', 'Other Indirect'],
                    datasets: [{
                        data: [
                            {{ scopes.scope1 | default(0) | round(1) }},
                            {{ scopes.scope2 | default(0) | round(1) }},
                            {{ scopes.scope3 | default(0) | round(1) }}
                        ],
                        backgroundColor: [
                            '#0F7D5C',
                            '#0099A0',
                            '#12303B'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
            
            // Trend Chart - using dynamic data
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            const trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: {{ timeline.labels | tojson }},
                    datasets: [
                        {
                            label: 'Actual Emissions',
                            data: {{ timeline.actual | tojson }},
                            borderColor: '#0F7D5C',
                            backgroundColor: 'rgba(15, 125, 92, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Projected Emissions',
                            data: {{ timeline.projected | tojson }},
                            borderColor: '#0099A0',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'CO₂e (tons)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        });

        function refreshCharts() {
            // Reinitialize charts with updated data
            if (typeof scopeChart !== 'undefined') {
                scopeChart.destroy();
            }
            if (typeof trendChart !== 'undefined') {
                trendChart.destroy();
            }
            
            // Reinitialize the charts
            initializeCharts();
        }

        // Function to initialize charts
        function initializeCharts() {
            // Scope Chart
            const scopeCtx = document.getElementById('scopeChart').getContext('2d');
            window.scopeChart = new Chart(scopeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Direct Emissions', 'Energy Indirect', 'Other Indirect'],
                    datasets: [{
                        data: [
                            {{ scopes.scope1 | default(0) | round(1) }},
                            {{ scopes.scope2 | default(0) | round(1) }},
                            {{ scopes.scope3 | default(0) | round(1) }}
                        ],
                        backgroundColor: [
                            '#0F7D5C',
                            '#0099A0',
                            '#12303B'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
            
            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            window.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: {{ timeline.labels | tojson }},
                    datasets: [
                        {
                            label: 'Actual Emissions',
                            data: {{ timeline.actual | tojson }},
                            borderColor: '#0F7D5C',
                            backgroundColor: 'rgba(15, 125, 92, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Projected Emissions',
                            data: {{ timeline.projected | tojson }},
                            borderColor: '#0099A0',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'CO₂e (tons)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Check if we're returning from an edit operation
        document.addEventListener('DOMContentLoaded', function() {
            // Check URL for edit parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('edited') === 'true') {
                // Refresh charts after a short delay to ensure DOM is fully loaded
                setTimeout(refreshCharts, 500);
            }
            
            // Initialize charts on page load
            initializeCharts();
        });
    </script>
</body>
</html>
